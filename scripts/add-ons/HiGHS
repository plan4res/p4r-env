#!/usr/bin/env add-on

SHELL = /bin/sh

INSTALLDIR     = ${ADDONS_INSTALLDIR}
INSTALLDIR_TMP = ${ADDONS_INSTALLDIR_TMP}
CACHE_DIR      = ${ADDONS_CACHEDIR}
MAKEFILE_NAME  = $(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))
PKGNAME       := $(notdir $(MAKEFILE_NAME))

PKGURL  := https://github.com/ERGO-Code/HiGHS.git
BUILDDIR   := build

.PHONY: install check status clean uninstall help

define compile
	@cd $(PKGNAME) && mkdir -p build && cd build && \
	    cmake -S. -B build && \
		cmake --build build --parallel
endef

install: $(INSTALLDIR)/$(PKGNAME)
$(INSTALLDIR)/$(PKGNAME): compile
	@echo "Install $(PKGNAME) add-on"
	@rm -rf $(INSTALLDIR_TMP)/$(PKGNAME)
	@mkdir -p $(INSTALLDIR_TMP)/$(PKGNAME)
	@cd $(PKGNAME)/$(UMBRELLA)/$(BUILDDIR) && make -j$(getconf _NPROCESSORS_ONLN) install
ifneq ($(INSTALLDIR),$(INSTALLDIR_TMP))
	@rsync -au --copy-links $(INSTALLDIR_TMP)/$(PKGNAME) $(INSTALLDIR)
	@rm -rf $(INSTALLDIR_TMP)/$(PKGNAME)
endif
HELP += "  install : Install $(PKGNAME) add-on"

# Build Umbrella project
CMAKEFLAGS = -DCMAKE_INSTALL_PREFIX=$(INSTALLDIR_TMP)/$(PKGNAME)

# Download the project code
$(PKGNAME):
	git clone $(PKGURL)

compile: $(PKGNAME)
	@mkdir -p $(PKGNAME)/$(BUILDDIR) && \
	cd $(PKGNAME) && \
	cmake $(CMAKEFLAGS) -S. -B $(BUILDDIR) && \
	cd $(BUILDDIR) && \
	make -j$(getconf _NPROCESSORS_ONLN) install

status:
	@if test -f $(INSTALLDIR)/$(PKGNAME)/VERSION ; then \
                cat $(INSTALLDIR)/$(PKGNAME)/VERSION ; \
        else \
                echo "not installed"; \
        fi
HELP += "   status : Print $(PKGNAME) version"

clean:
	@echo "Clean $(PKGNAME) add-on build directory"
	@((cd $(PKGNAME)/$(PKGVER)/build && make -k clean) || echo "Error: clean not possible! Is $(PKGNAME) add-on installed?") 2> /dev/null
HELP += "    clean : Clean $(PKGNAME) build directory"

######
###### Common to all add-ons
######

uninstall:
	@echo "Remove $(PKGNAME) add-on build and installation directories"
	@rm -rf $(PKGNAME)
	@rm -rf $(INSTALLDIR)/$(PKGNAME)
	@rm -rf $(INSTALLDIR_TMP)/$(PKGNAME)
	@rm -rf $(CACHE_DIR)/$(PKGNAME)
HELP += "uninstall : Remove $(PKGNAME) build and installation directories"

help:
	@echo "Targets for $(PKGNAME) add-on (first target as default):"
	@printf "   %s\n" $(HELP)
HELP += "     help : This help"
